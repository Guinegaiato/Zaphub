
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZapHub Pro - Automação & CRM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.460.0/dist/umd/lucide.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#0B1120', light: '#1e293b' },
              gold: { DEFAULT: '#d4af37', light: '#f3e5ab', dark: '#aa8c2c' }
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // --- CONFIG & CONSTANTS ---
      
      const DDD_MAP = {
        11: 'SP - São Paulo (Capital)', 12: 'SP - Vale do Paraíba', 13: 'SP - Baixada Santista', 14: 'SP - Bauru/Marília', 15: 'SP - Sorocaba', 16: 'SP - Ribeirão Preto', 17: 'SP - Rio Preto', 18: 'SP - Pres. Prudente', 19: 'SP - Campinas',
        21: 'RJ - Rio de Janeiro', 22: 'RJ - Campos', 24: 'RJ - Volta Redonda',
        27: 'ES - Vitória', 28: 'ES - Cachoeiro',
        31: 'MG - Belo Horizonte', 32: 'MG - Juiz de Fora', 33: 'MG - Gov. Valadares', 34: 'MG - Uberlândia', 35: 'MG - Poços de Caldas', 37: 'MG - Divinópolis', 38: 'MG - Montes Claros',
        41: 'PR - Curitiba', 42: 'PR - Ponta Grossa', 43: 'PR - Londrina', 44: 'PR - Maringá', 45: 'PR - Foz do Iguaçu', 46: 'PR - Francisco Beltrão',
        47: 'SC - Joinville', 48: 'SC - Florianópolis', 49: 'SC - Chapecó',
        51: 'RS - Porto Alegre', 53: 'RS - Pelotas', 54: 'RS - Caxias do Sul', 55: 'RS - Santa Maria',
        61: 'DF - Brasília', 62: 'GO - Goiânia', 64: 'GO - Rio Verde',
        63: 'TO - Tocantins',
        65: 'MT - Cuiabá', 66: 'MT - Rondonópolis',
        67: 'MS - Campo Grande',
        68: 'AC - Acre', 69: 'RO - Rondônia',
        71: 'BA - Salvador', 73: 'BA - Ilhéus', 74: 'BA - Juazeiro', 75: 'BA - Feira de Santana', 77: 'BA - Barreiras',
        79: 'SE - Sergipe',
        81: 'PE - Recife', 87: 'PE - Petrolina',
        82: 'AL - Alagoas',
        83: 'PB - Paraíba',
        84: 'RN - Rio Grande do Norte',
        85: 'CE - Fortaleza', 88: 'CE - Juazeiro do Norte',
        86: 'PI - Teresina', 89: 'PI - Picos',
        91: 'PA - Belém', 93: 'PA - Santarém', 94: 'PA - Marabá',
        92: 'AM - Manaus', 97: 'AM - Coari',
        95: 'RR - Roraima',
        96: 'AP - Amapá',
        98: 'MA - São Luís', 99: 'MA - Imperatriz'
      };

      const NICHES = [
        { id: 'lawyer', label: 'Advocacia (Criminal/Família)', icon: 'scale' },
        { id: 'accounting', label: 'Contadores para MEIs', icon: 'calculator' },
        { id: 'dentist_aesthetic', label: 'Dentistas Estéticos', icon: 'sparkles' },
        { id: 'ortho', label: 'Ortodontia', icon: 'smile' },
        { id: 'psych', label: 'Psicólogos e Psiquiatras', icon: 'users' },
        { id: 'coach', label: 'Coach Executivo', icon: 'crown' },
        { id: 'franchise', label: 'Consultor de Franquias', icon: 'trending-up' },
        { id: 'realestate', label: 'Imobiliária Alto Padrão', icon: 'home' },
        { id: 'insurance', label: 'Corretor Seguros de Vida', icon: 'shield-check' },
        { id: 'architect', label: 'Arquiteto de Interiores', icon: 'pen-tool' },
        { id: 'design_com', label: 'Designer Comercial', icon: 'briefcase' },
        { id: 'safety', label: 'Eng. Segurança Trabalho', icon: 'hard-hat' },
        { id: 'pest', label: 'Empresas de Dedetização', icon: 'bug' },
        { id: 'furniture', label: 'Móveis Planejados', icon: 'sofa' },
        { id: 'curtains', label: 'Persianas Automatizadas', icon: 'blinds' },
        { id: 'cctv', label: 'Empresas de CFTV', icon: 'video' },
        { id: 'solar', label: 'Placas Solares', icon: 'sun' },
        { id: 'music', label: 'Escola de Música', icon: 'music' },
        { id: 'language', label: 'Escola de Idiomas', icon: 'languages' },
        { id: 'tutoring', label: 'Reforço para Concursos', icon: 'book-open' },
        { id: 'organizer', label: 'Personal Organizer', icon: 'layers' },
        { id: 'physio', label: 'Fisioterapia Domiciliar', icon: 'activity' },
        { id: 'acu', label: 'Acupuntura Estética', icon: 'sparkles' },
        { id: 'tattoo', label: 'Estúdio de Tatuagem', icon: 'palette' },
        { id: 'dispatcher', label: 'Despachante', icon: 'file-text' },
        { id: 'dentist', label: 'Clínicas Odontológicas', icon: 'smile' },
        { id: 'food', label: 'Lanchonetes', icon: 'utensils' },
        { id: 'aesthetics', label: 'Clínicas de Estética', icon: 'sparkles' },
        { id: 'derma', label: 'Dermatologia', icon: 'activity' },
        { id: 'laser', label: 'Depilação a Laser', icon: 'zap' },
        { id: 'facilities', label: 'Manutenção Predial', icon: 'hammer' },
        { id: 'logistics', label: 'Transportadoras', icon: 'truck' },
        { id: 'trainer', label: 'Personal Trainer', icon: 'dumbbell' },
      ];

      // --- ICONS (LUCIDE WRAPPER) ---
      const Icon = ({ name, size = 18, className = "" }) => {
        // Fallback safety if Lucide fails to load
        if (!window.lucide || !window.lucide.icons) {
            return <span className={`inline-block bg-gray-400 rounded-sm ${className}`} style={{ width: size, height: size }}></span>;
        }
        return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
      };

      const useLucide = () => {
        useEffect(() => {
          if (window.lucide) {
              window.lucide.createIcons();
          }
        });
      };

      // --- HELPERS ---
      const sanitizePhone = (phone) => {
        if (!phone) return '';
        let str = String(phone).replace(/\D/g, ''); 
        if (str.length < 8) return ''; 
        if (str.length <= 9) return str; 
        if (str.length === 10 || str.length === 11) str = '55' + str;
        return str;
      };

      const getCityFromPhone = (phone) => {
        if (!phone || phone.length < 12) return 'Desconhecido';
        const ddd = phone.substring(2, 4);
        return DDD_MAP[parseInt(ddd)] || `Região DDD ${ddd}`;
      };

      const generateLink = (phone, msg) => `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

      // --- APP COMPONENT ---
      const App = () => {
        useLucide();
        const [activeView, setActiveView] = useState('home'); // home, history, reports, niche_ID
        const [activeNiche, setActiveNiche] = useState(null);
        
        // Data State
        const [fileData, setFileData] = useState([]);
        const [fileName, setFileName] = useState('');
        const [headers, setHeaders] = useState([]);
        const [mapStep, setMapStep] = useState(false);
        const [colName, setColName] = useState(-1);
        const [colPhone, setColPhone] = useState(-1);
        
        const [leads, setLeads] = useState([]);
        const [message, setMessage] = useState("Olá! Vi seu contato e gostaria de falar sobre nossos serviços.");
        
        // History State (Enhanced with CRM fields)
        const [history, setHistory] = useState([]);
        const [selectedLead, setSelectedLead] = useState(null); // For Modal

        // LOAD HISTORY ON MOUNT
        useEffect(() => {
          const saved = localStorage.getItem('ZAPHUB_HISTORY_V2');
          if (saved) {
             try {
               setHistory(JSON.parse(saved));
             } catch (e) { console.error(e); }
          }
        }, []);

        // --- UPLOAD LOGIC ---
        const handleFileUpload = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          setFileName(file.name);
          
          const reader = new FileReader();
          reader.onload = (evt) => {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
            
            let startIndex = 0;
            for(let i=0; i<Math.min(data.length, 20); i++) {
                const rowStr = JSON.stringify(data[i]).toLowerCase();
                if(rowStr.includes('nome') || rowStr.includes('cliente') || rowStr.includes('aluno') || rowStr.includes('tel') || rowStr.includes('cel')) {
                    startIndex = i;
                    break;
                }
            }
            
            const cleanData = data.slice(startIndex);
            if (cleanData.length > 0) {
              setFileData(cleanData);
              setHeaders(cleanData[0].map((h, i) => ({ idx: i, val: h || `Coluna ${i+1}` })));
              setMapStep(true);
              setColName(-1);
              setColPhone(-1);
              setActiveView('home');
            }
          };
          reader.readAsBinaryString(file);
        };

        // --- PROCESS ---
        const processLeads = () => {
          if (colName === -1 || colPhone === -1) {
            alert("Selecione as colunas de NOME e TELEFONE.");
            return;
          }
          
          const processed = [];
          for (let i = 1; i < fileData.length; i++) {
             const row = fileData[i];
             if (!row) continue;
             const rawName = row[colName];
             const rawPhone = row[colPhone];
             if (!rawName && !rawPhone) continue;

             const cleanPhone = sanitizePhone(rawPhone);
             const isValid = cleanPhone.length >= 12;

             processed.push({
               id: i,
               name: rawName || 'Sem Nome',
               rawPhone: rawPhone,
               phone: cleanPhone,
               status: isValid ? 'valid' : 'invalid',
               link: isValid ? generateLink(cleanPhone, message) : '#',
               sent: checkHistory(cleanPhone)
             });
          }
          setLeads(processed);
          setMapStep(false);
          setActiveView('list');
        };

        // --- HISTORY & CRM LOGIC ---
        const checkHistory = (phone) => history.some(h => h.phone === phone);

        const addToHistory = (lead) => {
          if (checkHistory(lead.phone)) return;
          const today = new Date();
          const newEntry = {
            phone: lead.phone,
            name: lead.name,
            timestamp: today.getTime(),
            dateStr: today.toLocaleDateString('pt-BR'),
            timeStr: today.toLocaleTimeString('pt-BR'),
            hour: today.getHours(), // For heatmap
            niche: activeNiche?.label || 'Geral',
            crmStatus: 'sent', // sent, replied, converted
            tags: []
          };
          
          const newHistory = [newEntry, ...history];
          updateHistory(newHistory);
          setLeads(prev => prev.map(l => l.id === lead.id ? { ...l, sent: true } : l));
        };

        const updateHistory = (newData) => {
           setHistory(newData);
           localStorage.setItem('ZAPHUB_HISTORY_V2', JSON.stringify(newData));
        };

        const updateLeadStatus = (phone, newStatus) => {
           const newData = history.map(h => h.phone === phone ? { ...h, crmStatus: newStatus } : h);
           updateHistory(newData);
           if(selectedLead && selectedLead.phone === phone) {
               setSelectedLead({ ...selectedLead, crmStatus: newStatus });
           }
        };

        const addTag = (phone, tag) => {
           const newData = history.map(h => {
               if(h.phone === phone) {
                   const tags = h.tags || [];
                   if(!tags.includes(tag)) return { ...h, tags: [...tags, tag] };
               }
               return h;
           });
           updateHistory(newData);
           if(selectedLead && selectedLead.phone === phone) {
               const tags = selectedLead.tags || [];
               if(!tags.includes(tag)) setSelectedLead({ ...selectedLead, tags: [...tags, tag] });
           }
        };

        const handleSend = (lead) => {
           if (lead.status !== 'valid') return;
           window.open(lead.link, '_blank');
           addToHistory(lead);
        };

        const copyAll = () => {
          const text = leads.filter(l => l.status === 'valid').map(l => `${l.name}: ${l.link}`).join('\n');
          navigator.clipboard.writeText(text);
          alert("Links copiados!");
        };

        // --- RENDERERS ---

        const RenderSidebar = () => (
          <aside className="w-64 bg-primary text-gray-300 flex flex-col h-screen overflow-y-auto shrink-0 border-r border-gray-800">
            <div className="p-6">
              <h1 className="text-2xl font-serif font-bold text-white flex items-center">
                <span className="text-gold mr-2">⚡</span> ZapHub
              </h1>
            </div>
            <nav className="flex-1 px-3 space-y-1">
              <button onClick={() => { setActiveView('home'); setActiveNiche(null); }} className={`w-full flex items-center px-3 py-2 rounded-lg transition-colors ${activeView === 'home' ? 'bg-gold text-primary font-bold' : 'hover:bg-gray-800'}`}>
                <Icon name="upload" className="mr-3"/> Início / Upload
              </button>
              
              <button onClick={() => { setActiveView('reports'); setActiveNiche(null); }} className={`w-full flex items-center px-3 py-2 rounded-lg transition-colors ${activeView === 'reports' ? 'bg-gold text-primary font-bold' : 'hover:bg-gray-800'}`}>
                <Icon name="bar-chart-2" className="mr-3"/> Dashboard CRM
              </button>

              <button onClick={() => { setActiveView('history'); setActiveNiche(null); }} className={`w-full flex items-center px-3 py-2 rounded-lg transition-colors ${activeView === 'history' ? 'bg-gold text-primary font-bold' : 'hover:bg-gray-800'}`}>
                <Icon name="history" className="mr-3"/> Histórico Rico
              </button>

              <div className="mt-6 mb-2 px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Nichos</div>
              {NICHES.map(niche => (
                <button
                  key={niche.id}
                  onClick={() => { setActiveNiche(niche); setActiveView('niche'); }}
                  className={`w-full flex items-center px-3 py-2 rounded-lg text-sm transition-colors ${activeNiche?.id === niche.id ? 'bg-gray-800 text-white border-l-2 border-gold' : 'hover:bg-gray-800'}`}
                >
                  <Icon name={niche.icon} className="mr-3 opacity-70" size={16}/> {niche.label}
                </button>
              ))}
            </nav>
          </aside>
        );

        const RenderReports = () => {
           // Stats Calculation
           const total = history.length;
           const todayDate = new Date().toLocaleDateString('pt-BR');
           const todayCount = history.filter(h => h.dateStr === todayDate).length;
           
           // CRM Funnel
           const replied = history.filter(h => h.crmStatus === 'replied' || h.crmStatus === 'converted').length;
           const converted = history.filter(h => h.crmStatus === 'converted').length;
           
           // Health/Safety Score Logic (Volume based)
           // 0-50: Safe (High), 51-200: Moderate, 200+: Risky
           let safetyScore = 100;
           let safetyLabel = "Alta (Seguro)";
           let safetyColor = "text-green-500";
           if (todayCount > 50) { safetyScore = 70; safetyLabel = "Média"; safetyColor = "text-yellow-500"; }
           if (todayCount > 200) { safetyScore = 30; safetyLabel = "Risco de Ban"; safetyColor = "text-red-500"; }
           
           // Heatmap Logic (By Hour)
           const hours = Array(24).fill(0);
           history.forEach(h => {
             if (h.hour !== undefined) hours[h.hour]++;
           });
           const maxHour = Math.max(...hours) || 1; // avoid div by zero

           return (
             <div className="p-8 animate-fade-in w-full max-w-7xl mx-auto pb-20">
                <h2 className="text-3xl font-serif font-bold text-primary mb-6 flex items-center">
                  <Icon name="bar-chart-2" className="mr-3 text-gold" size={32}/> Dashboard & Performance
                </h2>
                
                {/* --- TOP METRICS --- */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                   {/* NEW: Enviados Hoje - DESTACADO */}
                   <div className="bg-white p-5 rounded-xl shadow border-l-4 border-blue-600">
                      <div className="text-gray-400 text-xs font-bold uppercase">Enviados Hoje</div>
                      <div className="text-4xl font-bold text-blue-600 mt-2">{todayCount}</div>
                      <div className="text-xs text-gray-400 mt-1">{todayDate}</div>
                   </div>

                   <div className="bg-white p-5 rounded-xl shadow border-l-4 border-gray-400">
                      <div className="text-gray-400 text-xs font-bold uppercase">Total Enviado</div>
                      <div className="text-3xl font-bold text-primary mt-1">{total}</div>
                      <div className="text-xs text-gray-400 mt-1">Desde o início</div>
                   </div>

                   <div className="bg-white p-5 rounded-xl shadow border-l-4 border-purple-500">
                      <div className="text-gray-400 text-xs font-bold uppercase">Taxa de Resposta</div>
                      <div className="text-3xl font-bold text-purple-600 mt-1">
                         {total > 0 ? ((replied / total) * 100).toFixed(1) : 0}%
                      </div>
                      <div className="text-xs text-gray-400 mt-1">{replied} respostas</div>
                   </div>

                   <div className="bg-white p-5 rounded-xl shadow border-l-4 border-green-500">
                      <div className="text-gray-400 text-xs font-bold uppercase">Vendas</div>
                      <div className="text-3xl font-bold text-green-600 mt-1">
                         {total > 0 ? ((converted / total) * 100).toFixed(1) : 0}%
                      </div>
                      <div className="text-xs text-gray-400 mt-1">{converted} conversões</div>
                   </div>

                   <div className="bg-white p-5 rounded-xl shadow border-l-4 border-red-400">
                      <div className="text-gray-400 text-xs font-bold uppercase">Saúde da Conta</div>
                      <div className={`text-3xl font-bold mt-1 ${safetyColor}`}>{safetyScore}%</div>
                      <div className="text-xs text-gray-400 mt-1">{safetyLabel}</div>
                   </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                   {/* --- HEATMAP --- */}
                   <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                      <h3 className="font-bold text-gray-800 mb-4 flex items-center">
                         <Icon name="clock" className="mr-2 text-gray-400" size={18}/> Melhores Horários (Heatmap)
                      </h3>
                      <div className="flex items-end space-x-1 h-48">
                         {hours.map((count, i) => (
                           <div key={i} className="flex-1 flex flex-col justify-end group relative">
                              <div 
                                className={`w-full rounded-t transition-all duration-300 ${count === 0 ? 'bg-gray-100' : 'bg-blue-500 hover:bg-blue-600'}`} 
                                style={{ height: `${(count/maxHour)*100}%` }}
                              ></div>
                              <span className="text-[10px] text-gray-400 text-center mt-1">{i}h</span>
                              
                              {/* Tooltip */}
                              <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                {count} envios
                              </div>
                           </div>
                         ))}
                      </div>
                      <p className="text-xs text-gray-400 mt-4 text-center">Volume de envios por hora do dia. Use para saber quando você é mais produtivo.</p>
                   </div>

                   {/* --- CRM TIPS --- */}
                   <div className="bg-gradient-to-br from-primary to-slate-800 p-6 rounded-xl shadow text-white">
                      <h3 className="font-bold text-gold mb-4 flex items-center">
                        <Icon name="shield" className="mr-2" size={18}/> Dicas de Segurança
                      </h3>
                      <ul className="space-y-3 text-sm text-gray-300">
                        <li className="flex items-start"><span className="text-gold mr-2">•</span> Aqueça o chip: comece enviando 10-20 msgs/dia.</li>
                        <li className="flex items-start"><span className="text-gold mr-2">•</span> Varie as mensagens para evitar detecção de spam.</li>
                        <li className="flex items-start"><span className="text-gold mr-2">•</span> Nunca envie mais de 500 mensagens/dia em um chip pessoal.</li>
                        <li className="flex items-start"><span className="text-gold mr-2">•</span> Se a "Saúde da Conta" cair, pare por 24h.</li>
                      </ul>
                   </div>
                </div>
             </div>
           );
        };

        const LeadDetailModal = ({ lead, onClose }) => {
           if (!lead) return null;
           const city = getCityFromPhone(lead.phone);
           
           return (
             <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                   <div className="bg-primary p-6 flex justify-between items-start">
                      <div>
                         <h3 className="text-xl font-bold text-white mb-1">{lead.name}</h3>
                         <p className="text-gold-light font-mono">{lead.phone}</p>
                      </div>
                      <button onClick={onClose} className="text-white/50 hover:text-white"><Icon name="x"/></button>
                   </div>
                   
                   <div className="p-6">
                      <div className="grid grid-cols-2 gap-4 mb-6">
                         <div className="p-3 bg-gray-50 rounded border">
                            <label className="text-xs text-gray-400 uppercase">Região</label>
                            <div className="font-medium text-gray-700">{city}</div>
                         </div>
                         <div className="p-3 bg-gray-50 rounded border">
                            <label className="text-xs text-gray-400 uppercase">Primeiro Contato</label>
                            <div className="font-medium text-gray-700">{lead.dateStr}</div>
                         </div>
                      </div>

                      <div className="mb-6">
                         <label className="text-sm font-bold text-gray-700 mb-2 block">Status do Funil</label>
                         <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => updateLeadStatus(lead.phone, 'sent')} className={`flex-1 py-2 text-xs font-bold rounded ${lead.crmStatus === 'sent' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>Enviado</button>
                            <button onClick={() => updateLeadStatus(lead.phone, 'replied')} className={`flex-1 py-2 text-xs font-bold rounded ${lead.crmStatus === 'replied' ? 'bg-blue-100 text-blue-700' : 'text-gray-400 hover:text-blue-500'}`}>Respondeu</button>
                            <button onClick={() => updateLeadStatus(lead.phone, 'converted')} className={`flex-1 py-2 text-xs font-bold rounded ${lead.crmStatus === 'converted' ? 'bg-green-100 text-green-700' : 'text-gray-400 hover:text-green-500'}`}>Vendeu ($)</button>
                         </div>
                      </div>

                      <div className="mb-6">
                         <label className="text-sm font-bold text-gray-700 mb-2 block">Tags</label>
                         <div className="flex flex-wrap gap-2 mb-2">
                            {(lead.tags || []).map(t => (
                               <span key={t} className="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded-full">{t}</span>
                            ))}
                         </div>
                         <div className="flex gap-2">
                            {['Quente', 'Frio', 'Retorno', 'Sem Interesse'].map(tag => (
                               <button key={tag} onClick={() => addTag(lead.phone, tag)} className="px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-50">+ {tag}</button>
                            ))}
                         </div>
                      </div>
                      
                      <div className="flex gap-3">
                         <a href={`https://wa.me/${lead.phone}`} target="_blank" className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-bold text-center flex justify-center items-center">
                            <Icon name="message-circle" className="mr-2" size={16}/> Abrir WhatsApp
                         </a>
                      </div>
                   </div>
                </div>
             </div>
           );
        };

        const RenderHistory = () => (
          <div className="p-8 max-w-6xl mx-auto animate-fade-in pb-20">
             <div className="flex justify-between items-center mb-6">
               <h2 className="text-3xl font-serif font-bold text-primary">Histórico Rico (CRM)</h2>
               <button onClick={() => { if(confirm('Apagar tudo?')) { localStorage.removeItem('ZAPHUB_HISTORY_V2'); setHistory([]); } }} className="text-red-500 text-sm hover:underline">Limpar Tudo</button>
             </div>
             
             <div className="bg-white rounded-xl shadow overflow-hidden">
                <table className="w-full text-left">
                  <thead className="bg-gray-50 text-gray-500 text-xs uppercase">
                    <tr>
                      <th className="p-4">Nome</th>
                      <th className="p-4">Telefone</th>
                      <th className="p-4">Status (CRM)</th>
                      <th className="p-4">Tags</th>
                      <th className="p-4 text-right">Ação</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {history.map((h, i) => (
                      <tr key={i} className="hover:bg-gray-50 cursor-pointer group" onClick={() => setSelectedLead(h)}>
                        <td className="p-4 font-medium text-gray-900">{h.name}</td>
                        <td className="p-4 font-mono text-gray-600">{h.phone}</td>
                        <td className="p-4">
                           {h.crmStatus === 'converted' && <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Venda</span>}
                           {h.crmStatus === 'replied' && <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">Respondeu</span>}
                           {(!h.crmStatus || h.crmStatus === 'sent') && <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Enviado</span>}
                        </td>
                        <td className="p-4">
                           <div className="flex gap-1">
                             {(h.tags || []).slice(0, 2).map(t => <span key={t} className="w-2 h-2 rounded-full bg-gold" title={t}></span>)}
                             {(h.tags || []).length > 0 && <span className="text-xs text-gray-400 ml-1">{(h.tags || []).join(', ')}</span>}
                           </div>
                        </td>
                        <td className="p-4 text-right">
                           <button className="text-primary opacity-0 group-hover:opacity-100 font-bold text-xs border border-primary px-3 py-1 rounded hover:bg-primary hover:text-white transition-all">
                             Ver Detalhes
                           </button>
                        </td>
                      </tr>
                    ))}
                    {history.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">Nenhum histórico encontrado.</td></tr>}
                  </tbody>
                </table>
             </div>
             
             {selectedLead && <LeadDetailModal lead={selectedLead} onClose={() => setSelectedLead(null)} />}
          </div>
        );

        const RenderHome = () => (
          <div className="flex-1 flex flex-col items-center justify-center p-8 bg-gray-50 h-full">
            <div className="max-w-xl w-full text-center">
               <div className="inline-block p-4 bg-primary rounded-2xl shadow-2xl mb-6">
                 <Icon name="zap" className="text-gold w-12 h-12" />
               </div>
               <h1 className="text-4xl font-serif font-bold text-primary mb-2">ZapHub Pro</h1>
               <p className="text-gray-600 mb-8 text-lg">Central de automação de WhatsApp para múltiplos nichos.</p>
               
               <div className="bg-white p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 hover:border-gold transition-colors relative cursor-pointer group">
                  <input type="file" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onChange={handleFileUpload} accept=".csv, .xlsx, .xls" />
                  <div className="group-hover:scale-105 transition-transform duration-300">
                    <Icon name="file-spreadsheet" className="w-16 h-16 text-gray-300 mx-auto mb-4 group-hover:text-gold"/>
                    <h3 className="text-xl font-bold text-gray-700">Importar Lista de Leads</h3>
                    <p className="text-sm text-gray-400 mt-2">Arraste ou clique para selecionar (.xlsx / .csv)</p>
                  </div>
               </div>
               
               <div className="mt-8 flex justify-center gap-8 text-gray-400 text-sm">
                  <span className="flex items-center"><Icon name="shield" size={14} className="mr-1"/> 100% Seguro (Local)</span>
                  <span className="flex items-center"><Icon name="infinity" size={14} className="mr-1"/> Envios Ilimitados</span>
               </div>
            </div>
          </div>
        );
        
        const RenderMapping = () => (
           <div className="p-8 flex justify-center items-start pt-20 h-full">
             <div className="bg-white p-8 rounded-xl shadow-xl max-w-2xl w-full border-t-4 border-gold">
                <h2 className="text-2xl font-bold mb-2 flex items-center text-primary">
                  <Icon name="table" className="mr-2"/> Mapeamento de Colunas
                </h2>
                <p className="text-gray-500 mb-6">Identifique as colunas corretas do arquivo <strong>{fileName}</strong>.</p>
                
                <div className="grid grid-cols-2 gap-6 mb-8">
                  <div>
                    <label className="block font-bold text-gray-700 mb-2">Coluna de NOME</label>
                    <select className="w-full p-3 border rounded focus:ring-2 focus:ring-gold" value={colName} onChange={e => setColName(Number(e.target.value))}>
                       <option value="-1">Selecione...</option>
                       {headers.map(h => <option key={h.idx} value={h.idx}>{h.val}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block font-bold text-gray-700 mb-2">Coluna de CELULAR</label>
                    <select className="w-full p-3 border rounded focus:ring-2 focus:ring-gold" value={colPhone} onChange={e => setColPhone(Number(e.target.value))}>
                       <option value="-1">Selecione...</option>
                       {headers.map(h => <option key={h.idx} value={h.idx}>{h.val}</option>)}
                    </select>
                  </div>
                </div>
                
                <div className="bg-gray-50 p-4 rounded text-sm text-gray-500 mb-6">
                   <strong>Preview (Linha 1):</strong><br/>
                   Nome: {colName !== -1 ? fileData[1]?.[colName] : '...'} <br/>
                   Tel: {colPhone !== -1 ? fileData[1]?.[colPhone] : '...'}
                </div>

                <button onClick={processLeads} className="w-full bg-primary text-white py-4 rounded-lg font-bold hover:bg-gray-800 shadow-lg flex justify-center items-center">
                   Processar Lista <Icon name="arrow-right" className="ml-2"/>
                </button>
             </div>
           </div>
        );
        
        const RenderList = () => {
           const validLeads = leads.filter(l => l.status === 'valid');
           
           return (
             <div className="p-6 md:p-8 max-w-7xl mx-auto h-full flex flex-col pb-20">
                <div className="flex justify-between items-end mb-6">
                   <div>
                     <h2 className="text-3xl font-serif font-bold text-primary">{activeNiche?.label || 'Lista Geral'}</h2>
                     <p className="text-gray-500">{validLeads.length} contatos válidos prontos para envio.</p>
                   </div>
                   <div className="space-x-2">
                     <button onClick={copyAll} className="px-4 py-2 bg-white border rounded hover:bg-gray-50 text-sm font-medium">Copiar Links</button>
                   </div>
                </div>
                
                <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex gap-2 border border-gray-200">
                   <input className="flex-1 border-none outline-none text-gray-700" value={message} onChange={e => {
                      setMessage(e.target.value);
                      setLeads(prev => prev.map(l => ({...l, link: generateLink(l.phone, e.target.value)})));
                   }} />
                   <button className="text-gray-400 hover:text-gold"><Icon name="edit-2"/></button>
                </div>

                <div className="flex-1 bg-white rounded-xl shadow overflow-hidden flex flex-col border border-gray-200">
                   <div className="overflow-y-auto flex-1">
                      <table className="w-full text-left">
                        <thead className="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">
                          <tr>
                             <th className="p-4 w-24">Status</th>
                             <th className="p-4">Nome</th>
                             <th className="p-4">Telefone</th>
                             <th className="p-4 text-right">Ação</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                          {leads.map(lead => (
                            <tr key={lead.id} className={lead.status === 'invalid' ? 'bg-red-50' : (lead.sent ? 'bg-green-50' : 'hover:bg-gray-50')}>
                               <td className="p-4">
                                 {lead.status === 'invalid' ? <span className="text-red-500 font-bold text-xs">ERRO</span> : 
                                  lead.sent ? <span className="text-green-600 font-bold text-xs flex items-center"><Icon name="check" size={12} className="mr-1"/> OK</span> : 
                                  <span className="text-gray-400 text-xs">PEND</span>
                                 }
                               </td>
                               <td className="p-4 font-medium text-gray-900">{lead.name}</td>
                               <td className="p-4 text-gray-600 font-mono text-sm">{lead.status === 'valid' ? lead.phone : lead.rawPhone}</td>
                               <td className="p-4 text-right">
                                 {lead.status === 'valid' && (
                                   <button onClick={() => handleSend(lead)} className={`px-4 py-1 rounded-full text-xs font-bold transition-all ${lead.sent ? 'border border-green-500 text-green-600 bg-white' : 'bg-[#25D366] text-white hover:shadow-lg hover:scale-105'}`}>
                                     {lead.sent ? 'Reenviar' : 'Enviar WhatsApp'}
                                   </button>
                                 )}
                               </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                   </div>
                </div>
             </div>
           );
        };

        // --- MAIN RENDER ---
        return (
          <div className="flex h-screen overflow-hidden bg-gray-50">
             <RenderSidebar />
             <main className="flex-1 flex flex-col relative overflow-y-auto">
                {activeView === 'home' && <RenderHome />}
                {activeView === 'reports' && <RenderReports />}
                {activeView === 'history' && <RenderHistory />}
                {activeView === 'list' && <RenderList />}
                {(activeView === 'niche' || mapStep) && !mapStep && leads.length === 0 && (
                   // Niche Landing View
                   <div className="p-8">
                      <div className="flex items-center mb-6">
                        <div className="p-3 bg-white rounded shadow-sm mr-4"><Icon name={activeNiche?.icon || 'zap'} className="text-primary"/></div>
                        <h1 className="text-3xl font-serif font-bold text-primary">{activeNiche?.label}</h1>
                      </div>
                      <div className="bg-gradient-to-r from-primary to-gray-800 rounded-2xl p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                         <div className="relative z-10">
                           <h3 className="text-2xl font-bold mb-2">Módulo Especializado</h3>
                           <p className="text-gray-300 mb-6 max-w-lg">Otimizado para geração de leads em {activeNiche?.label}. Carregue sua lista para começar.</p>
                           <button onClick={() => document.getElementById('niche-upload').click()} className="bg-gold text-primary px-6 py-3 rounded-lg font-bold hover:bg-white transition-colors">Carregar Planilha Agora</button>
                           <input id="niche-upload" type="file" className="hidden" onChange={handleFileUpload} accept=".xlsx,.csv" />
                         </div>
                         <Icon name={activeNiche?.icon || 'zap'} size={200} className="absolute right-[-40px] bottom-[-40px] opacity-10"/>
                      </div>
                   </div>
                )}
                {mapStep && <RenderMapping />}
             </main>
             
             {/* Floating WhatsApp */}
             <a href="https://wa.me/?text=Suporte" target="_blank" className="fixed bottom-6 right-6 bg-[#25D366] text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform z-50">
               <Icon name="message-circle" size={32} className="fill-current"/>
             </a>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
